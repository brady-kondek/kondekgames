<!DOCTYPE html>
<html>
<head>
<title>Javascript Racer - v4 (final)</title>
<meta http-equiv=Content-Type content="text/html; charset=utf-8"/>
<link href=common.css rel=stylesheet type=text/css />
</head>
<body>
<table id=controls>
<tr>
<td colspan=2>
<a href=v1.straight.html>straight</a> |
<a href=v2.curves.html>curves</a> |
<a href=v3.hills.html>hills</a> |
<a href=v4.final.html>final</a>
</td>
</tr>
<tr><td id=fps colspan=2 align=right></td></tr>
<tr>
<th><label for=resolution>Resolution :</label></th>
<td>
<select id=resolution style=width:100%>
<option value=fine>Fine (1280x960)</option>
<option selected value=high>High (1024x768)</option>
<option value=medium>Medium (640x480)</option>
<option value=low>Low (480x360)</option>
</select>
</td>
</tr>
<tr>
<th><label for=lanes>Lanes :</label></th>
<td>
<select id=lanes>
<option>1</option>
<option>2</option>
<option selected>3</option>
<option>4</option>
</select>
</td>
</tr>
<tr>
<th><label for=roadWidth>Road Width (<span id=currentRoadWidth></span>) :</label></th>
<td><input id=roadWidth type=range min=500 max=3000 title="integer (500-3000)"></td>
</tr>
<tr>
<th><label for=cameraHeight>CameraHeight (<span id=currentCameraHeight></span>) :</label></th>
<td><input id=cameraHeight type=range min=500 max=5000 title="integer (500-5000)"></td>
</tr>
<tr>
<th><label for=drawDistance>Draw Distance (<span id=currentDrawDistance></span>) :</label></th>
<td><input id=drawDistance type=range min=100 max=500 title="integer (100-500)"></td>
</tr>
<tr>
<th><label for=fieldOfView>Field of View (<span id=currentFieldOfView></span>) :</label></th>
<td><input id=fieldOfView type=range min=80 max=140 title="integer (80-140)"></td>
</tr>
<tr>
<th><label for=fogDensity>Fog Density (<span id=currentFogDensity></span>) :</label></th>
<td><input id=fogDensity type=range min=0 max=50 title="integer (0-50)"></td>
</tr>
</table>
<div id=instructions>
<p>Use the <b>arrow keys</b> to drive the car.</p>
</div>
<div id=racer>
<div id=hud>
<span id=speed class=hud><span id=speed_value class=value>0</span> mph</span>
<span id=current_lap_time class=hud>Time: <span id=current_lap_time_value class=value>0.0</span></span>
<span id=last_lap_time class=hud>Last Lap: <span id=last_lap_time_value class=value>0.0</span></span>
<span id=fast_lap_time class=hud>Fastest Lap: <span id=fast_lap_time_value class=value>0.0</span></span>
</div>
<canvas id=canvas>
Sorry, this example cannot be run because your browser does not support the &lt;canvas&gt; element
</canvas>
Loading...
</div>
<audio id=music>
<source src=music/racer.ogg>
<source src=music/racer.mp3>
</audio>
<span id=mute></span>
<script src=stats.js></script>
<script src=common.js></script>
<script>var fps=60;var step=1/fps;var width=1024;var height=768;var centrifugal=0.3;var offRoadDecel=0.99;var skySpeed=0.001;var hillSpeed=0.002;var treeSpeed=0.003;var skyOffset=0;var hillOffset=0;var treeOffset=0;var segments=[];var cars=[];var stats=Game.stats("fps");var canvas=Dom.get("canvas");var ctx=canvas.getContext("2d");var background=null;var sprites=null;var resolution=null;var roadWidth=2000;var segmentLength=200;var rumbleLength=3;var trackLength=null;var lanes=3;var fieldOfView=100;var cameraHeight=1000;var cameraDepth=null;var drawDistance=300;var playerX=0;var playerZ=null;var fogDensity=5;var position=0;var speed=0;var maxSpeed=segmentLength/step;var accel=maxSpeed/5;var breaking=-maxSpeed;var decel=-maxSpeed/5;var offRoadDecel=-maxSpeed/2;var offRoadLimit=maxSpeed/4;var totalCars=200;var currentLapTime=0;var lastLapTime=null;var keyLeft=false;var keyRight=false;var keyFaster=false;var keySlower=false;var hud={speed:{value:null,dom:Dom.get("speed_value")},current_lap_time:{value:null,dom:Dom.get("current_lap_time_value")},last_lap_time:{value:null,dom:Dom.get("last_lap_time_value")},fast_lap_time:{value:null,dom:Dom.get("fast_lap_time_value")}};function update(b){var c,g,f,h,i;var a=findSegment(position+playerZ);var d=SPRITES.PLAYER_STRAIGHT.w*SPRITES.SCALE;var k=speed/maxSpeed;var j=b*2*k;var e=position;updateCars(b,a,d);position=Util.increase(position,b*speed,trackLength);if(keyLeft){playerX=playerX-j}else{if(keyRight){playerX=playerX+j}}playerX=playerX-(j*k*a.curve*centrifugal);if(keyFaster){speed=Util.accelerate(speed,accel,b)}else{if(keySlower){speed=Util.accelerate(speed,breaking,b)}else{speed=Util.accelerate(speed,decel,b)}}if((playerX<-1)||(playerX>1)){if(speed>offRoadLimit){speed=Util.accelerate(speed,offRoadDecel,b)}for(c=0;c<a.sprites.length;c++){h=a.sprites[c];i=h.source.w*SPRITES.SCALE;if(Util.overlap(playerX,d,h.offset+i/2*(h.offset>0?1:-1),i)){speed=maxSpeed/5;position=Util.increase(a.p1.world.z,-playerZ,trackLength);break}}}for(c=0;c<a.cars.length;c++){g=a.cars[c];f=g.sprite.w*SPRITES.SCALE;if(speed>g.speed){if(Util.overlap(playerX,d,g.offset,f,0.8)){speed=g.speed*(g.speed/speed);position=Util.increase(g.z,-playerZ,trackLength);break}}}playerX=Util.limit(playerX,-3,3);speed=Util.limit(speed,0,maxSpeed);skyOffset=Util.increase(skyOffset,skySpeed*a.curve*(position-e)/segmentLength,1);hillOffset=Util.increase(hillOffset,hillSpeed*a.curve*(position-e)/segmentLength,1);treeOffset=Util.increase(treeOffset,treeSpeed*a.curve*(position-e)/segmentLength,1);if(position>playerZ){if(currentLapTime&&(e<playerZ)){lastLapTime=currentLapTime;currentLapTime=0;if(lastLapTime<=Util.toFloat(Dom.storage.fast_lap_time)){Dom.storage.fast_lap_time=lastLapTime;updateHud("fast_lap_time",formatTime(lastLapTime));Dom.addClassName("fast_lap_time","fastest");Dom.addClassName("last_lap_time","fastest")}else{Dom.removeClassName("fast_lap_time","fastest");Dom.removeClassName("last_lap_time","fastest")}updateHud("last_lap_time",formatTime(lastLapTime));Dom.show("last_lap_time")}else{currentLapTime+=b}}updateHud("speed",5*Math.round(speed/500));updateHud("current_lap_time",formatTime(currentLapTime))}function updateCars(f,e,a){var g,b,d,c;for(g=0;g<cars.length;g++){b=cars[g];d=findSegment(b.z);b.offset=b.offset+updateCarOffset(b,d,e,a);b.z=Util.increase(b.z,f*b.speed,trackLength);b.percent=Util.percentRemaining(b.z,segmentLength);c=findSegment(b.z);if(d!=c){index=d.cars.indexOf(b);d.cars.splice(index,1);c.cars.push(b)}}}function updateCarOffset(m,g,a,e){var h,f,d,k,c,n,b=20,l=m.sprite.w*SPRITES.SCALE;if((g.index-a.index)>drawDistance){return 0}for(h=1;h<b;h++){k=segments[(g.index+h)%segments.length];if((k===a)&&(m.speed>speed)&&(Util.overlap(playerX,e,m.offset,l,1.2))){if(playerX>0.5){d=-1}else{if(playerX<-0.5){d=1}else{d=(m.offset>playerX)?1:-1}}return d*1/h*(m.speed-speed)/maxSpeed}for(f=0;f<k.cars.length;f++){c=k.cars[f];n=c.sprite.w*SPRITES.SCALE;if((m.speed>c.speed)&&Util.overlap(m.offset,l,c.offset,n,1.2)){if(c.offset>0.5){d=-1}else{if(c.offset<-0.5){d=1}else{d=(m.offset>c.offset)?1:-1}}return d*1/h*(m.speed-c.speed)/maxSpeed}}}if(m.offset<-0.9){return 0.1}else{if(m.offset>0.9){return -0.1}else{return 0}}}function updateHud(a,b){if(hud[a].value!==b){hud[a].value=b;Dom.set(hud[a].dom,b)}}function formatTime(b){var a=Math.floor(b/60);var c=Math.floor(b-(a*60));var d=Math.floor(10*(b-Math.floor(b)));if(a>0){return a+"."+(c<10?"0":"")+c+"."+d}else{return c+"."+d}}function render(){var q=findSegment(position);var a=Util.percentRemaining(position,segmentLength);var b=findSegment(position+playerZ);var p=Util.percentRemaining(position+playerZ,segmentLength);var d=Util.interpolate(b.p1.world.y,b.p2.world.y,p);var h=height;var k=0;var r=-(q.curve*a);ctx.clearRect(0,0,width,height);Render.background(ctx,background,width,height,BACKGROUND.SKY,skyOffset,resolution*skySpeed*d);Render.background(ctx,background,width,height,BACKGROUND.HILLS,hillOffset,resolution*hillSpeed*d);Render.background(ctx,background,width,height,BACKGROUND.TREES,treeOffset,resolution*treeSpeed*d);var c,e,g,m,o,f,l,j;for(c=0;c<drawDistance;c++){g=segments[(q.index+c)%segments.length];g.looped=g.index<q.index;g.fog=Util.exponentialFog(c/drawDistance,fogDensity);g.clip=h;Util.project(g.p1,(playerX*roadWidth)-k,d+cameraHeight,position-(g.looped?trackLength:0),cameraDepth,width,height,roadWidth);Util.project(g.p2,(playerX*roadWidth)-k-r,d+cameraHeight,position-(g.looped?trackLength:0),cameraDepth,width,height,roadWidth);k=k+r;r=r+g.curve;if((g.p1.camera.z<=cameraDepth)||(g.p2.screen.y>=g.p1.screen.y)||(g.p2.screen.y>=h)){continue}Render.segment(ctx,width,lanes,g.p1.screen.x,g.p1.screen.y,g.p1.screen.w,g.p2.screen.x,g.p2.screen.y,g.p2.screen.w,g.fog,g.color);h=g.p1.screen.y}for(c=(drawDistance-1);c>0;c--){g=segments[(q.index+c)%segments.length];for(e=0;e<g.cars.length;e++){m=g.cars[e];o=m.sprite;f=Util.interpolate(g.p1.screen.scale,g.p2.screen.scale,m.percent);l=Util.interpolate(g.p1.screen.x,g.p2.screen.x,m.percent)+(f*m.offset*roadWidth*width/2);j=Util.interpolate(g.p1.screen.y,g.p2.screen.y,m.percent);Render.sprite(ctx,width,height,resolution,roadWidth,sprites,m.sprite,f,l,j,-0.5,-1,g.clip)}for(e=0;e<g.sprites.length;e++){o=g.sprites[e];f=g.p1.screen.scale;l=g.p1.screen.x+(f*o.offset*roadWidth*width/2);j=g.p1.screen.y;Render.sprite(ctx,width,height,resolution,roadWidth,sprites,o.source,f,l,j,(o.offset<0?-1:0),-1,g.clip)}if(g==b){Render.player(ctx,width,height,resolution,roadWidth,sprites,speed/maxSpeed,cameraDepth/playerZ,width/2,(height/2)-(cameraDepth/playerZ*Util.interpolate(b.p1.camera.y,b.p2.camera.y,p)*height/2),speed*(keyLeft?-1:keyRight?1:0),b.p2.world.y-b.p1.world.y)}}}function findSegment(a){return segments[Math.floor(a/segmentLength)%segments.length]}function lastY(){return(segments.length==0)?0:segments[segments.length-1].p2.world.y}function addSegment(a,c){var b=segments.length;segments.push({index:b,p1:{world:{y:lastY(),z:b*segmentLength},camera:{},screen:{}},p2:{world:{y:c,z:(b+1)*segmentLength},camera:{},screen:{}},curve:a,sprites:[],cars:[],color:Math.floor(b/rumbleLength)%2?COLORS.DARK:COLORS.LIGHT})}function addSprite(c,a,b){segments[c].sprites.push({source:a,offset:b})}function addRoad(e,a,i,c,g){var d=lastY();var h=d+(Util.toInt(g,0)*segmentLength);var b,f=e+a+i;for(b=0;b<e;b++){addSegment(Util.easeIn(0,c,b/e),Util.easeInOut(d,h,b/f))}for(b=0;b<a;b++){addSegment(c,Util.easeInOut(d,h,(e+b)/f))}for(b=0;b<i;b++){addSegment(Util.easeInOut(c,0,b/i),Util.easeInOut(d,h,(e+a+b)/f))}}var ROAD={LENGTH:{NONE:0,SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{NONE:0,EASY:2,MEDIUM:4,HARD:6}};function addStraight(a){a=a||ROAD.LENGTH.MEDIUM;addRoad(a,a,a,0,0)}function addHill(b,a){b=b||ROAD.LENGTH.MEDIUM;a=a||ROAD.HILL.MEDIUM;addRoad(b,b,b,0,a)}function addCurve(b,c,a){b=b||ROAD.LENGTH.MEDIUM;c=c||ROAD.CURVE.MEDIUM;a=a||ROAD.HILL.NONE;addRoad(b,b,b,c,a)}function addLowRollingHills(b,a){b=b||ROAD.LENGTH.SHORT;a=a||ROAD.HILL.LOW;addRoad(b,b,b,0,a/2);addRoad(b,b,b,0,-a);addRoad(b,b,b,ROAD.CURVE.EASY,a);addRoad(b,b,b,0,0);addRoad(b,b,b,-ROAD.CURVE.EASY,a/2);addRoad(b,b,b,0,0)}function addSCurves(){addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.NONE);addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM);addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.EASY,-ROAD.HILL.LOW);addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.MEDIUM);addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.MEDIUM,-ROAD.HILL.MEDIUM)}function addBumps(){addRoad(10,10,10,0,5);addRoad(10,10,10,0,-2);addRoad(10,10,10,0,-5);addRoad(10,10,10,0,8);addRoad(10,10,10,0,5);addRoad(10,10,10,0,-7);addRoad(10,10,10,0,5);addRoad(10,10,10,0,-2)}function addDownhillToEnd(a){a=a||200;addRoad(a,a,a,-ROAD.CURVE.EASY,-lastY()/segmentLength)}function resetRoad(){segments=[];addStraight(ROAD.LENGTH.SHORT);addLowRollingHills();addSCurves();addCurve(ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.LOW);addBumps();addLowRollingHills();addCurve(ROAD.LENGTH.LONG*2,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM);addStraight();addHill(ROAD.LENGTH.MEDIUM,ROAD.HILL.HIGH);addSCurves();addCurve(ROAD.LENGTH.LONG,-ROAD.CURVE.MEDIUM,ROAD.HILL.NONE);addHill(ROAD.LENGTH.LONG,ROAD.HILL.HIGH);addCurve(ROAD.LENGTH.LONG,ROAD.CURVE.MEDIUM,-ROAD.HILL.LOW);addBumps();addHill(ROAD.LENGTH.LONG,-ROAD.HILL.MEDIUM);addStraight();addSCurves();addDownhillToEnd();resetSprites();resetCars();segments[findSegment(playerZ).index+2].color=COLORS.START;segments[findSegment(playerZ).index+3].color=COLORS.START;for(var a=0;a<rumbleLength;a++){segments[segments.length-1-a].color=COLORS.FINISH}trackLength=segments.length*segmentLength}function resetSprites(){var e,c;addSprite(20,SPRITES.BILLBOARD07,-1);addSprite(40,SPRITES.BILLBOARD06,-1);addSprite(60,SPRITES.BILLBOARD08,-1);addSprite(80,SPRITES.BILLBOARD09,-1);addSprite(100,SPRITES.BILLBOARD01,-1);addSprite(120,SPRITES.BILLBOARD02,-1);addSprite(140,SPRITES.BILLBOARD03,-1);addSprite(160,SPRITES.BILLBOARD04,-1);addSprite(180,SPRITES.BILLBOARD05,-1);addSprite(240,SPRITES.BILLBOARD07,-1.2);addSprite(240,SPRITES.BILLBOARD06,1.2);addSprite(segments.length-25,SPRITES.BILLBOARD07,-1.2);addSprite(segments.length-25,SPRITES.BILLBOARD06,1.2);for(e=10;e<200;e+=4+Math.floor(e/100)){addSprite(e,SPRITES.PALM_TREE,0.5+Math.random()*0.5);addSprite(e,SPRITES.PALM_TREE,1+Math.random()*2)}for(e=250;e<1000;e+=5){addSprite(e,SPRITES.COLUMN,1.1);addSprite(e+Util.randomInt(0,5),SPRITES.TREE1,-1-(Math.random()*2));addSprite(e+Util.randomInt(0,5),SPRITES.TREE2,-1-(Math.random()*2))}for(e=200;e<segments.length;e+=3){addSprite(e,Util.randomChoice(SPRITES.PLANTS),Util.randomChoice([1,-1])*(2+Math.random()*5))}var b,a,d;for(e=1000;e<(segments.length-50);e+=100){b=Util.randomChoice([1,-1]);addSprite(e+Util.randomInt(0,50),Util.randomChoice(SPRITES.BILLBOARDS),-b);for(c=0;c<20;c++){a=Util.randomChoice(SPRITES.PLANTS);d=b*(1.5+Math.random());addSprite(e+Util.randomInt(0,50),a,d)}}}function resetCars(){cars=[];var g,a,c,f,e,b,d;for(var g=0;g<totalCars;g++){f=Math.random()*Util.randomChoice([-0.8,0.8]);e=Math.floor(Math.random()*segments.length)*segmentLength;b=Util.randomChoice(SPRITES.CARS);d=maxSpeed/4+Math.random()*maxSpeed/(b==SPRITES.SEMI?4:2);a={offset:f,z:e,sprite:b,speed:d};c=findSegment(a.z);c.cars.push(a);cars.push(a)}}Game.run({canvas:canvas,render:render,update:update,stats:stats,step:step,images:["background","sprites"],keys:[{keys:[KEY.LEFT,KEY.A],mode:"down",action:function(){keyLeft=true}},{keys:[KEY.RIGHT,KEY.D],mode:"down",action:function(){keyRight=true}},{keys:[KEY.UP,KEY.W],mode:"down",action:function(){keyFaster=true}},{keys:[KEY.DOWN,KEY.S],mode:"down",action:function(){keySlower=true}},{keys:[KEY.LEFT,KEY.A],mode:"up",action:function(){keyLeft=false}},{keys:[KEY.RIGHT,KEY.D],mode:"up",action:function(){keyRight=false}},{keys:[KEY.UP,KEY.W],mode:"up",action:function(){keyFaster=false}},{keys:[KEY.DOWN,KEY.S],mode:"up",action:function(){keySlower=false}}],ready:function(a){background=a[0];sprites=a[1];reset();Dom.storage.fast_lap_time=Dom.storage.fast_lap_time||180;updateHud("fast_lap_time",formatTime(Util.toFloat(Dom.storage.fast_lap_time)))}});function reset(a){a=a||{};canvas.width=width=Util.toInt(a.width,width);canvas.height=height=Util.toInt(a.height,height);lanes=Util.toInt(a.lanes,lanes);roadWidth=Util.toInt(a.roadWidth,roadWidth);cameraHeight=Util.toInt(a.cameraHeight,cameraHeight);drawDistance=Util.toInt(a.drawDistance,drawDistance);fogDensity=Util.toInt(a.fogDensity,fogDensity);fieldOfView=Util.toInt(a.fieldOfView,fieldOfView);segmentLength=Util.toInt(a.segmentLength,segmentLength);rumbleLength=Util.toInt(a.rumbleLength,rumbleLength);cameraDepth=1/Math.tan((fieldOfView/2)*Math.PI/180);playerZ=(cameraHeight*cameraDepth);resolution=height/480;refreshTweakUI();if((segments.length==0)||(a.segmentLength)||(a.rumbleLength)){resetRoad()}}Dom.on("resolution","change",function(d){var a,c,b;switch(d.target.options[d.target.selectedIndex].value){case"fine":a=1280;c=960;b=a/width;break;case"high":a=1024;c=768;b=a/width;break;case"medium":a=640;c=480;b=a/width;break;case"low":a=480;c=360;b=a/width;break}reset({width:a,height:c});Dom.blur(d)});Dom.on("lanes","change",function(a){Dom.blur(a);reset({lanes:a.target.options[a.target.selectedIndex].value})});Dom.on("roadWidth","change",function(a){Dom.blur(a);reset({roadWidth:Util.limit(Util.toInt(a.target.value),Util.toInt(a.target.getAttribute("min")),Util.toInt(a.target.getAttribute("max")))})});Dom.on("cameraHeight","change",function(a){Dom.blur(a);reset({cameraHeight:Util.limit(Util.toInt(a.target.value),Util.toInt(a.target.getAttribute("min")),Util.toInt(a.target.getAttribute("max")))})});Dom.on("drawDistance","change",function(a){Dom.blur(a);reset({drawDistance:Util.limit(Util.toInt(a.target.value),Util.toInt(a.target.getAttribute("min")),Util.toInt(a.target.getAttribute("max")))})});Dom.on("fieldOfView","change",function(a){Dom.blur(a);reset({fieldOfView:Util.limit(Util.toInt(a.target.value),Util.toInt(a.target.getAttribute("min")),Util.toInt(a.target.getAttribute("max")))})});Dom.on("fogDensity","change",function(a){Dom.blur(a);reset({fogDensity:Util.limit(Util.toInt(a.target.value),Util.toInt(a.target.getAttribute("min")),Util.toInt(a.target.getAttribute("max")))})});function refreshTweakUI(){Dom.get("lanes").selectedIndex=lanes-1;Dom.get("currentRoadWidth").innerHTML=Dom.get("roadWidth").value=roadWidth;Dom.get("currentCameraHeight").innerHTML=Dom.get("cameraHeight").value=cameraHeight;Dom.get("currentDrawDistance").innerHTML=Dom.get("drawDistance").value=drawDistance;Dom.get("currentFieldOfView").innerHTML=Dom.get("fieldOfView").value=fieldOfView;Dom.get("currentFogDensity").innerHTML=Dom.get("fogDensity").value=fogDensity};</script>
</body>
</html>